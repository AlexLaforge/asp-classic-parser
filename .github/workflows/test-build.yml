name: Test Cross-Compilation

on:
  push:
    branches: [ test-build ]
  workflow_dispatch:

jobs:
  build-linux:
    name: Build Linux
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-unknown-linux-gnu

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y pkg-config libssl-dev musl-tools

      - name: Install Cross
        run: cargo install cross --git https://github.com/cross-rs/cross

      - name: Set environment variables for OpenSSL
        run: |
          echo "OPENSSL_STATIC=1" >> $GITHUB_ENV
          echo "CARGO_FEATURE_VENDORED=1" >> $GITHUB_ENV
          echo "OPENSSL_DIR=/usr/lib/ssl" >> $GITHUB_ENV

      - name: Build with Cross (aarch64)
        run: cross build --release --target aarch64-unknown-linux-gnu

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: x86_64-pc-windows-msvc

      - name: Build for Windows
        run: cargo build --release --target x86_64-pc-windows-msvc
        env:
          CARGO_FEATURE_VENDORED: 1
          OPENSSL_STATIC: 1